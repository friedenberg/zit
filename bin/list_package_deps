#! /bin/bash -e

ag_print_matching() (
	query="$1"
	shift

	ag "$query" \
		--only-matching \
		--no-file \
		--no-color \
		--no-group \
		--no-break \
		"$@"
)

ag_print_matching_with_file() (
	query="$1"
	shift

	ag "$query" \
		--no-number \
		--no-color \
		--no-group \
		--no-break \
		"$@"
)

print_matches() (
	path="$1"
	ag_print_matching 'github.com/friedenberg/zit/src/\w+' "$path"
)

print_basenames() (
	while IFS= read -r; do
		basename "$REPLY"
	done
)

print_final() (
	dir="$(dirname "$1")"
	dep="$2"

	w="50"
	printf "%${w}s %${w}s\n" "$dir" "$dep"
)

export -f print_final

print_package_locations() (
	loc="$1"
	while IFS= read -r; do
		ag_print_matching_with_file \
			"\\bgithub.com/friedenberg/zit/src/$REPLY/\\w+\\b" \
			"$loc" </dev/null |
			tr -d ' ' |
			sed -e 's#github.com/friedenberg/zit/##g; s/"//g' |
			xargs -L2 bash -c 'print_final "$@"' "$REPLY" |
			sort -u
	done
)

print_matches "$1" |
	print_basenames |
	sort -u |
	print_package_locations "$1" |
  tail
